<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Debugging - Quokka</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Debugging";
        var mkdocs_page_input_path = "debugging.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Quokka
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../about/">About</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../equations/">Equations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../citation/">Citation</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">User guide</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../installation/">Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../running_on_hpc_clusters/">Running on HPC clusters</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tests/">Test problems</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../parameters/">Runtime parameters</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../insitu_analysis/">In-situ analysis</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../postprocessing/">Postprocessing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../instability/">Debugging simulation instability</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Test problems</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../tests/radshock/">Radiative shock test</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tests/shu_osher/">Shu-Osher shock test</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tests/sms/">Slow-moving shock test</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tests/energy_exchange/">Matter-radiation temperature equilibrium test</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tests/radhydro_uniform_adv/">Uniform advecting radiation in diffusive limit</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">DEVELOPER GUIDE</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../flowchart/">Flowchart</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Debugging</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#general-guidelines">General guidelines</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#common-bugs">Common bugs</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#how-to-debug-on-gpus">How to debug on GPUs</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#how-to-actually-debug-on-gpus">How to actually debug on GPUs</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#gpu-kernel-asynchronicity">GPU kernel asynchronicity</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#when-all-else-fails-debugging-with-printf">When all else fails: Debugging with printf</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../error_checking/">Assertions and error checking</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../performance/">Performance tips</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../howto_clang_tidy/">How to use clang-tidy</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Quokka</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">DEVELOPER GUIDE</li>
      <li class="breadcrumb-item active">Debugging</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="debugging">Debugging</h1>
<h2 id="general-guidelines">General guidelines</h2>
<p>A good general guide to debugging simulation codes is <a href="https://warpx.readthedocs.io/en/latest/usage/workflows/debugging.html">provided by WarpX</a> (although some details are WarpX-specific).</p>
<h2 id="common-bugs">Common bugs</h2>
<p>You might be reading this page because you have encountered a common type of bug:</p>
<ul>
<li>
<p>an <a href="https://www.geeksforgeeks.org/accessing-array-bounds-ccpp/">out-of-bounds array access</a></p>
<p>This is when the code accesses an array with an index that corresponds to an element that doesn't actually exist. In C++, this causes the computer to access a memory location that is completely unrelated to the array that you intended to access. In a CPU code, this usually causes a silently incorrect result, but on GPU, this may actually cause the simulation to crash. However, if you are accessing an <code>amrex::Array4</code> object <em>and you have compiled in Debug mode</em>, then AMReX will issue an error message when this occurs. There is a significant performance cost to this error checking, so it does not occur when compiled in Release mode.</p>
</li>
<li>
<p>accessing a host variable from the GPU</p>
<p>The second most common type of bug encountered in Quokka is accessing a host variable (i.e., a variable that can only be accessed from code that runs on the CPU) from code running on the GPU (i.e., within a <code>ParallelFor</code>). Sometimes the compiler will detect this situation and print an error message, but often this will only present an issue when actuallly running the code -- for instance, this can happen when the GPU code tries to dereference a pointer to an address in CPU memory. In that case, the only way to debug this error is to run Quokka under <code>cuda-gdb</code> (or, on AMD GPUs, <code>rocgdb</code>).</p>
</li>
</ul>
<h2 id="how-to-debug-on-gpus">How to debug on GPUs</h2>
<p>The best way to debug on GPUs is to... not debug on GPUs. That is, it is always easier to instead debug the problem on a CPU-only run. GPU debugging is very painful and itself quite buggy. This is unfortunately true for all GPU vendors.</p>
<ul>
<li>Try to shrink the problem to a size that can run on a single node, or (even better) a single MPI rank / CPU core, but where it still exhibits the error that you are trying to debug.</li>
<li>Build Quokka without GPU support but with <code>-DCMAKE_BUILD_TYPE=Debug</code> and re-run. If there are any array out-of-bounds errors, it will stop and report exactly which array is being accessed out-of-bounds and what the indices are. The only downside is that Quokka will run very slowly in this mode.<ul>
<li>For more details, see the <a href="https://amrex-codes.github.io/amrex/docs_html/Debugging.html">AMReX debugging guide</a>.</li>
</ul>
</li>
<li>Build Quokka without GPU support but with <code>-DCMAKE_BUILD_TYPE=Release -DENABLE_ASAN=ON</code>. This turns on the AddressSanitizer, which checks for out-of-bounds array accesses and other memory bugs. This is faster than the previous method, but it produces less informative error messages (e.g., no array indices).<ul>
<li>This method may produce a lot of messages about memory leaks, <a href="https://stackoverflow.com/a/654766">which are not necessarily bugs</a>, and should not cause GPU crashes. These messages <a href="https://stackoverflow.com/questions/51060801/how-to-suppress-leaksanitizer-report-when-running-under-fsanitize-address">can be disabled</a> if you are looking for, e.g., out-of-bounds array accesses, which is a class of bug that can cause a GPU crash.</li>
<li>It is recommended to set these environment variables when you run it: <code>ASAN_OPTIONS=abort_on_error=1:fast_unwind_on_malloc=1:detect_leaks=0 UBSAN_OPTIONS=print_stacktrace=0</code>. Note that CTest appends its own options to this environment variable when running tests, so it is recommended to run the simulation manually (i.e., without <code>make test</code>, <code>ninja test</code>, or <code>ctest</code>).</li>
<li>For more information, see this <a href="https://www.osc.edu/resources/getting_started/howto/howto_use_address_sanitizer">guide to using AddressSanitizer in an HPC context</a>.</li>
</ul>
</li>
<li>On AMD GPUs, there is a <a href="https://rocm.docs.amd.com/en/latest/understand/using_gpu_sanitizer.html#compiling-for-address-sanitizer">GPU-aware AddressSanitizer</a>. Currently, enabling this requires manually changing the compiler flags.</li>
</ul>
<h2 id="how-to-actually-debug-on-gpus">How to actually debug on GPUs</h2>
<p>As an <em>absolute last resort</em> if it is impossible to reproduce the error you are seeing on a CPU-only run, then the best option is to:</p>
<ul>
<li>downsize the simulation to fit on a single GPU</li>
<li>start the simulation on an NVIDIA GPU from within CUDA-GDB (see the <a href="https://docs.nvidia.com/cuda/cuda-gdb/index.html">CUDA-GDB documentation</a> and <a href="https://www.olcf.ornl.gov/wp-content/uploads/2021/06/cuda_training_series_cuda_debugging.pdf">slides</a>).</li>
<li>hope CUDA-GDB does not itself crash</li>
<li>hope CUDA-GDB produces a useful error message that you can analyze</li>
</ul>
<p>NVIDIA also provides the <code>compute-sanitizer</code> tool that is essentially the equivalent of AddressSanitizer (see the <a href="https://docs.nvidia.com/compute-sanitizer/ComputeSanitizer/index.html">ComputeSanitizer documentation</a>). Unfortunately, it does not work as reliably as AddressSanitizer, and may itself crash while attempting to debug a GPU program.</p>
<p>For AMD GPUs, you have to use the AMD-provided debugger <code>rocgdb</code>. A tutorial its use is available <a href="https://www.olcf.ornl.gov/wp-content/uploads/2021/04/rocgdb_hipmath_ornl_2021_v2.pdf">here</a>.</p>
<p>AMD also provides a GPU-aware AddressSanitizer that can be enabled when building Quokka. Currently, the compiler flags must be manually modified in order to enable this. For details, see its <a href="https://rocm.docs.amd.com/en/latest/understand/using_gpu_sanitizer.html#compiling-for-address-sanitizer">documentation</a>.</p>
<h2 id="gpu-kernel-asynchronicity">GPU kernel asynchronicity</h2>
<p><strong>By default, GPU kernels launch asynchronously, i.e., execution of CPU code continues before the kernel starts on the GPU. This can cause synchronization problems if there is an implicit assumption about the order of operations with respect to CPU and GPU code.</strong></p>
<p>The easiest way to debug this is to set the environment variables:</p>
<ul>
<li><code>CUDA_LAUNCH_BLOCKING=1</code> on NVIDIA GPUs, or</li>
<li><code>HIP_LAUNCH_BLOCKING=1</code> on AMD GPUs.</li>
</ul>
<p>This will cause the CPU to wait until the GPU kernel execution is complete before continuing past the call to <code>ParallelFor</code>.</p>
<p>For more details, refer to the <a href="https://amrex-codes.github.io/amrex/docs_html/Debugging.html#basic-gpu-debugging">AMReX GPU debugging guide</a>.</p>
<h2 id="when-all-else-fails-debugging-with-printf">When all else fails: Debugging with <code>printf</code></h2>
<p>If you have tried <em>all</em> of the above steps, then you have to resort to adding <code>printf</code> statements within the GPU code. Note that <code>printf</code> inside GPU code is different from the CPU-side <code>printf</code> function, as explained in the <a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#formatted-output">NVIDIA documentation</a>.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../flowchart/" class="btn btn-neutral float-left" title="Flowchart"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../error_checking/" class="btn btn-neutral float-right" title="Assertions and error checking">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Â© Copyright 2020-2024, Ben Wibking and Quokka Developers.</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../flowchart/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../error_checking/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../javascripts/mathjax.js"></script>
      <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
